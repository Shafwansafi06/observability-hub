# =============================================================================
# IAM Service Accounts Configuration
# =============================================================================

service_accounts:
  # Main Vertex AI inference service account
  - name: vertex-ai-inference
    display_name: "Vertex AI Inference Service Account"
    description: "Service account for Vertex AI online predictions"
    roles:
      - roles/aiplatform.user
      - roles/storage.objectViewer
      - roles/logging.logWriter
      - roles/monitoring.metricWriter
      - roles/cloudtrace.agent
    
    workload_identity:
      enabled: true
      kubernetes_service_account: "vertex-ai-sa"
      namespace: "production"
    
    keys:
      rotation_period: "90d"
      managed: true

  # Cloud Run service account for Next.js API
  - name: nextjs-api-runner
    display_name: "Next.js API Service Account"
    description: "Service account for Cloud Run Next.js API"
    roles:
      - roles/aiplatform.user  # With conditions
      - roles/secretmanager.secretAccessor
      - roles/logging.logWriter
      - roles/monitoring.metricWriter
    
    conditions:
      - role: roles/aiplatform.user
        title: "Only predict endpoints"
        expression: |
          resource.name.startsWith("projects/PROJECT_ID/locations/REGION/endpoints/") &&
          resource.service == "aiplatform.googleapis.com" &&
          request.method == "predict"

  # Batch prediction service account
  - name: vertex-ai-batch
    display_name: "Vertex AI Batch Prediction Service Account"
    description: "Service account for batch predictions"
    roles:
      - roles/aiplatform.user
      - roles/storage.objectAdmin  # For input/output buckets
      - roles/logging.logWriter

  # Monitoring service account
  - name: vertex-ai-monitoring
    display_name: "Vertex AI Monitoring Service Account"
    description: "Service account for monitoring and alerting"
    roles:
      - roles/monitoring.metricWriter
      - roles/logging.logWriter
      - roles/cloudtrace.agent
      - roles/aiplatform.viewer

# =============================================================================
# IAM Policies
# =============================================================================

policies:
  # Production endpoint - restricted access
  - resource: "endpoints/PRODUCTION_ENDPOINT_ID"
    bindings:
      - role: roles/aiplatform.user
        members:
          - serviceAccount:vertex-ai-inference@PROJECT_ID.iam.gserviceaccount.com
          - serviceAccount:nextjs-api-runner@PROJECT_ID.iam.gserviceaccount.com
        condition:
          title: "Production hours only"
          expression: |
            request.time.getHours() >= 6 &&
            request.time.getHours() <= 22

  # Canary endpoint - wider access for testing
  - resource: "endpoints/CANARY_ENDPOINT_ID"
    bindings:
      - role: roles/aiplatform.user
        members:
          - serviceAccount:vertex-ai-inference@PROJECT_ID.iam.gserviceaccount.com
          - group:ml-engineers@company.com

  # Model registry - read-only for most
  - resource: "models/*"
    bindings:
      - role: roles/aiplatform.viewer
        members:
          - group:engineering@company.com
      
      - role: roles/aiplatform.admin
        members:
          - group:ml-platform-admins@company.com

  # Storage buckets for models
  - resource: "buckets/PROJECT_ID-vertex-ai-models"
    bindings:
      - role: roles/storage.objectViewer
        members:
          - serviceAccount:vertex-ai-inference@PROJECT_ID.iam.gserviceaccount.com
      
      - role: roles/storage.objectAdmin
        members:
          - serviceAccount:vertex-ai-batch@PROJECT_ID.iam.gserviceaccount.com
          - group:ml-platform-admins@company.com

# =============================================================================
# Best Practices
# =============================================================================

best_practices:
  - name: "Principle of Least Privilege"
    description: "Grant only minimum necessary permissions"
    
  - name: "Separate Service Accounts"
    description: "Use different SAs for different environments (dev/staging/prod)"
    
  - name: "Key Rotation"
    description: "Rotate service account keys every 90 days"
    
  - name: "Conditional Access"
    description: "Use IAM conditions to restrict access by time, IP, or resource"
    
  - name: "Audit Logging"
    description: "Enable all audit logs for security and compliance"
    
  - name: "Workload Identity"
    description: "Use Workload Identity instead of service account keys where possible"

# =============================================================================
# Audit Configuration
# =============================================================================

audit_config:
  - service: aiplatform.googleapis.com
    audit_log_configs:
      - log_type: ADMIN_READ
      - log_type: DATA_READ
        exempted_members:
          - serviceAccount:vertex-ai-monitoring@PROJECT_ID.iam.gserviceaccount.com
      - log_type: DATA_WRITE

  - service: storage.googleapis.com
    audit_log_configs:
      - log_type: ADMIN_READ
      - log_type: DATA_READ
      - log_type: DATA_WRITE

# =============================================================================
# Setup Script
# =============================================================================

# To apply this configuration:
# gcloud iam service-accounts create vertex-ai-inference \
#   --display-name="Vertex AI Inference Service Account" \
#   --project=PROJECT_ID
#
# gcloud projects add-iam-policy-binding PROJECT_ID \
#   --member="serviceAccount:vertex-ai-inference@PROJECT_ID.iam.gserviceaccount.com" \
#   --role="roles/aiplatform.user"
